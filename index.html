<html>
  <head>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/react-router-dom/5.0.1/react-router-dom.js'></script>
  <style>
    body {
      font-family: 'Verdana';
    }
    .nav {
      display: flex;
      justify-content: space-around;
      padding: 1rem;
      font-weight: 50%;
    }
    .selected {
      border: solid 1px black;
      padding: 0.5rem;
    }
  </style>
  </head>
  <body>
    <div id='root'></div>
    <script type='text/babel'>
      
      const { render } = ReactDOM;
      const { createElement, Component } = React;
      const { HashRouter, Link, Route, Switch, Redirect } = ReactRouterDOM;

      const Nav = ({ underFive, fiveAndOver, products, companies, offerings, path }) => {
        return (
          <div className='nav'>
            <Link to='/products/underFive' className={path === '/underFive' ? 'selected' : ''}>Under 5 ({ products.length })</Link>
            <Link to='/products/fiveAndOver' className={path === '/fiveAndOver' ? 'selected' : ''}>5 And Over ({ products.length })</Link>
          </div>
        );
      }

      const Products = ( { underFive, fiveAndOver, products, companies, offerings } ) => {
        const processed = products.map( product => {
          let sum = 0;
          let companyName = ''
          let lowestPrice = Infinity
          const _offerings = offerings.filter( offering => offering.productId === product.id)
            .map( offering => {
              sum += offering.price
              const company = companies.find( company => company.id === offering.companyId);
              if (offering.price < lowestPrice) {
                lowestPrice = offering.price;
                companyName = company.name;
              }
              return {...offering, company: company }
            });
            return {...product, offerings: _offerings, averagePrice: sum / _offerings.length, lowestPrice: lowestPrice, companyName: companyName};
        });

        return (
          <div>
          {
            processed.map( product => <div key={ product.id }>
              { product.name }
              <br />
              { product.suggestedPrice }.00
              <hr />
            </div>)
          }
          </div>
        );
      }

      class App extends Component {
        constructor() {
          super();
          this.state = {
            underFive: [],
            fiveAndOver: [],
            products: [],
            companies: [],
            offerings: []
          }
        }
        async componentDidMount() {
          const urls = [
            'https://acme-users-api-rev.herokuapp.com/api/products',
            'https://acme-users-api-rev.herokuapp.com/api/companies',
            'https://acme-users-api-rev.herokuapp.com/api/offerings'
          ];
          const responses = await Promise.all(urls.map( url => axios.get( url )))
          const [products, companies, offerings] = responses.map( response => response.data );
          this.setState({ products, companies, offerings });
        }
        render() {
          const { underFive, fiveAndOver, products, companies, offerings } = this.state
          return (
            <HashRouter>
              <Route render={ ({ location }) => <Nav path = { location.pathname } products = { products } /> } />
              <Switch>
                <Route path='/products/underFive'  render = { () => <Products
                    products = { products }
                    companies = { companies } 
                    offerings = { offerings } 
                  /> } 
                />
                <Route path='/products/fiveAndOver' render = { () => <Products
                    products = { products }
                    companies = { companies } 
                    offerings = { offerings }
                  /> } 
                />
                <Redirect to='/products/underFive' />
              </Switch>
            </HashRouter>
          );
        }
      }

      const root = document.querySelector('#root');
      render( <App />, root ); 
    </script>
  </body>
</html>